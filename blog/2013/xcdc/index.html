<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    
    <!-- Website verification -->
    <meta name="google-site-verification" content="xRlThgNzCzfRY8XKsahsru2gLV-Cc284pbsdHHnr2oY">
<meta name="msvalidate.01" content="">
<!-- Avoid warning on Google Chrome
        Error with Permissions-Policy header: Origin trial controlled feature not enabled: 'interest-cohort'.
        see https://stackoverflow.com/a/75119417
    -->
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>The eXtreme Computer Design Competition 2013 | Saurav  Kumar</title>
    <meta name="author" content="Saurav  Kumar">
    <meta name="description" content="">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/img/pcb.jpg">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://k45v.github.io/blog/2013/xcdc/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Saurav </span>Kumar</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <li class="nav-item">
              <!-- cv -->
                <a class="nav-link" href="/assets/pdf/example_pdf.pdf">cv
                </a>
              </li>

              <!-- Other pages -->

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">The eXtreme Computer Design Competition 2013</h1>
    <p class="post-meta">April 5, 2013</p>
       
  </header>

  <article class="post-content">
    <div class="float-left mr-3 w-50">
  <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/img_2395-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/img_2395-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/img_2395-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/img_2395.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">

  </picture>

</figure>

</div>
<p>It has been quite some time since I participated in a competition (2010 was the last time @ <a href="/blog/2010/daq/">FSG</a>). I had been waiting for the <a href="https://sites.google.com/a/ncsu.edu/xcdc2013/home" rel="external nofollow noopener" target="_blank">XCDC2013</a> and what an amazing experience it was!!!</p>

<p>I learn’t a lot and thoroughly enjoyed the team work. It was like a symphony. Spending hours with my team mates Bharat and Roshan, sprouting new approaches and bouncing ideas off each other. I can never forget that moment when at 2am in the Hunt library we managed to Overclock the Snapdragon S3 (APQ8060) on the <a href="https://developer.qualcomm.com/mobile-development/development-devices/snapdragon-mdp-legacy-devices" rel="external nofollow noopener" target="_blank">MSM8660</a> (Dragonboard) and there were high fives all around. In this blog post I will try to cover everything what we did/tried for this event. (The <a href="#appendix">Appendix section</a> has all the detailed procedures)</p>

<p><strong>Problem Statement:</strong> Optimize the Page load speed of a web browser on the platform previously mentioned. We had to improve both performance and energy efficiency.</p>

<p>Before we begin the optimizations/changes we need to know how to measure the performance and energy efficiency. So, we decided to rely on the following tools:</p>

<ul>
  <li>
<strong>Browser benchmarks:</strong> Use the benchmarks mentioned <a href="http://wikis.lib.ncsu.edu/index.php/XCDC_Android_Development#Browser_Benchmarks" rel="external nofollow noopener" target="_blank">here</a> to check page load times for your browser. Okay now go use <a href="http://www.webkit.org/perf/sunspider-0.9.1/sunspider-0.9.1/driver.html" rel="external nofollow noopener" target="_blank">this link</a> to see which out of Chrome, IE and Firefox is fastest on your PC… No seriously, try it out.</li>
  <li>
<strong>DDMS/Traceview:</strong> Dalvik Debug Monitor Server (DDMS) is accessible via Eclipse and is present in the <a href="http://developer.android.com/sdk/index.html" rel="external nofollow noopener" target="_blank">ADT bundle</a> tools section. It can be used to generate trace logs for applications/processes running on the target device. Use this to determine the costliest sections of the application.</li>
  <li>
<strong>Perf:</strong> The <a href="https://perf.wiki.kernel.org/index.php/Tutorial" rel="external nofollow noopener" target="_blank">perf</a> tool can be used for recording process activity information. Most of the frequently invoked code is written in native C. This is where perf comes in. The names of functions in perf reports are generated by JNI and they can be correlated with the corresponding “.so” (shared object files) shown in perf report. You can look for these functions in the source code for modifications. Additionally, you may check the hardware counters using perf (if enabled).</li>
  <li>
<strong>Trepn Profiler:</strong> This tool has been designed by Qualcomm to measure effects of an application on the mobile device’s power, data and CPU. The MDP (Mobile development platform) has embedded sensors which are used by <a href="https://developer.qualcomm.com/mobile-development/development-devices/trepn-profiler" rel="external nofollow noopener" target="_blank">trepn</a> to gather the required information and it allows saving all gathered data to a csv file.</li>
  <li>
<strong>AnTuTu Benchmark:</strong> The AnTuTu benchmark is an android app which gauges performance based on different tests. Though this does not measure browser performance, it is useful to determine general purpose performance.</li>
</ul>

<p>The MDP came with a stock gingerbread image. We ran the stock Android browser through the <a href="#perf-based-profiling">Profiling procedure</a> and collected data. Next we <a href="#flash-ics-stock-image-provided-by-bsquare-using-windows7">flashed Ice cream sandwich</a> on the MDP so that we can work on the Browser in the latest Android flavor compatible with the MDP. Then we profiled again to collect baseline data on ICS. Just upgrading to ICS gave a speedup of around 2 (compared to gingerbread baseline). We <a href="#compiling-ics-from-source">pulled the ICS source and compiled it</a> ( had some snacks, took a break, fixed some errors…this part over and over again) on 32-bit Ubuntu 12.04  and a MAC OSX 10.8.3.</p>

<p>Now came the interesting part OPTIMIZATIONS!!!</p>

<p>A look at the Sunspider trace collected from DDMS showed that the browser package is nowhere near the costliest sections. The major chunk of time is spent in Timer handling code which belongs to the Webcore package. Time to do a grep in the Kernel source. The outcome: we located frameworks/base/core/java/android/webkit/JWebCoreJavaBridge.java (Note that for all paths hereon we are in the ICS source directory that was pulled) where the method code was present. Then Surpiiissseee, the file is a bridge which provides interface for functions implemented in native C. Okay so now to look for the C code and we ended up at external/webkit/Source/WebKit/android/jni/JavaBridge.cpp . The code is small, the underlying functions are small and offer no avenues for the optimizations we had in mind (removing dependencies, vectorizing code for the Neon SIMD unit). Back to hunting for places to optimize. Next we found the code responsible for triggering shared timers. We reduced the max duration of firing timers at external/webkit/Source/WebCore/platform/ThreadTimers.cpp  in the webkit code. This just slowed the benchmarks down and we later figured out that this timer changes the interval at which next computation will be processed by Webkit <a href="http://homes.cs.washington.edu/~burg/projects/timelapse/articles/webkit-event-implementation/" rel="external nofollow noopener" target="_blank">(details here)</a>.</p>

<p>At this point we were going nowhere and just jumping from one function to another to find a small piece of code in every one of them. That’s when Bharat said let’s do kernel modifications. But where would we start? He proposed using a kernel module to overclock the processor <a href="http://forum.xda-developers.com/showthread.php?t=1158951" rel="external nofollow noopener" target="_blank">(refer this link)</a>. <a href="#permitting-apps-to-use-root">(Here is how we set up the needed apps)</a>. Well it was a new approach, we thought it’s worth a shot and began compiling the KMOD <a href="#makefile-to-compile-kmod-for-android-ics-source">(makefile here)</a>. Locating the kernel source directory and fixing the makefile was another challenge. We pulled Linux kernel and used that directory as source but it asked for configurations. Then we tried default configurations using “make menuconfig” and “make oldconfig”. No luck. A modinfo showed inconsistency in the vermagic. Finally found the exact source directory and did insmod successfully. The MDP rebooted! Tried another set of configurations another reboot and no messages using dmesg or logcat. Finally found kernel messages by doing “cat /proc/kmsg”. The module simply looked for for the voltage setting and replaced any entry in memory that matched the unsigned long value 1250000 with an appropriately different value. There was a illegal memory access which causes the Kernel oops, so we moved the start address for the lookup. Luckily the module got inserted for 1.5GHz setting (max frequency previously was 1.2GHz) and we ran the benchmark. We expected a speedup but instead the performance dropped by half. Maybe there was a mismatch in the L2, RAM and CPU frequency or the module replaced values in some other locations as well which had adverse affects on the system.</p>

<p>Down but not out, we decided to look into the kernel source to find matching functions and located the tables responsible for the clock setup and PLL (kernel/arch/arm/mach-msm/acpuclock-8×60.c). Bingo, went through the code, added entries, compiled and flashed. Checked the MDP. Yes! the changes reflected. Ran the benchmarks. Did it work? See for yourself:</p>

<div class="text-center">
<figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/performance_speedup-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/performance_speedup-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/performance_speedup-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/performance_speedup.png" class="img-fluid rounded w-75" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">

  </picture><figcaption class="caption">Browser speedup for benchmarks</figcaption>

</figure>

<figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/results_antutu-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/results_antutu-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/results_antutu-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/results_antutu.png" class="img-fluid rounded w-75" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">

  </picture><figcaption class="caption">Antutu scores (higher means better)</figcaption>

</figure>

</div>

<p>We presented out results and bagged the 3rd spot at the competition. Why not 1st? Well we overclocked the MDP, but then that reduces battery life. The scheduler and high-low frequencies at kernel level have been designed to give the best experience both in terms of performance and energy consumption. So, if we had concentrated more on the browser source (Chrome or <a href="https://wiki.mozilla.org/Mobile/Fennec/Android" rel="external nofollow noopener" target="_blank">Fennec</a>; we did compile source for Fennec which took about 7 hours on my system) maybe the results would have been different. Well, in that case we wouldn’t have overclocked the system right? In short what we did was definitely worth it!</p>

<p>With that ended our attempt at XCDC 2013 !!!</p>

<h2 id="appendix">Appendix</h2>

<h4 id="perf-based-profiling">Perf based profiling</h4>
<p>We used the precompiled perf made available on <a href="http://www.spencerpages.com/wiki/index.php?title=Dragonboard_8060_Development#Using_pre-compiled_perf" rel="external nofollow noopener" target="_blank">spencerpages wiki</a>.</p>
<ol>
  <li>Manually start the browser and note pid using:-
    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>adb shell ps | <span class="nb">grep </span>browser
</code></pre></div>    </div>
  </li>
  <li>Start the desired web page through adb shell
    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>am start <span class="nt">-a</span> android.intent.action.VIEW <span class="nt">-d</span> <span class="se">\</span>
http://www.webkit.org/perf/sunspider-0.9.1/sunspider-0.9.1/driver.html <span class="se">\</span>
<span class="nt">-n</span> com.android.browser/.BrowserActivity
</code></pre></div>    </div>
  </li>
  <li>Steps to initialize ‘perf’
    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PERF_PAGER</span><span class="o">=</span>/system/bin/cat
</code></pre></div>    </div>
    <p>for Gingerbread image use <code class="language-plaintext highlighter-rouge">#: perf record -p</code><br>
for ICS use (since hardware events not enabled) <code class="language-plaintext highlighter-rouge">#: perf record -e cpu-clock -F 500 -p</code></p>
  </li>
  <li>Run the Benchmark through the device</li>
  <li>When the benchmark run completes, kill ‘perf’ using ‘ctrl+c’</li>
  <li>Note the benchmark result that is being shown on the device</li>
  <li>The collected perf data can be viewed by using the command
    <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>perf report
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="trepn-profiling">Trepn profiling</h4>
<ol>
  <li>Install Trepn using the instructions provided at the <a href="https://developer.qualcomm.com/mobile-development/development-devices/trepn-profiler" rel="external nofollow noopener" target="_blank">official site</a>.</li>
  <li>After installation, open the Trepn Profiler App and in settings select the parameters that you wish to record. Then select “Profile an app” -&gt; select “Browser”.</li>
  <li>This will open the browser and the profiler will start collecting data.</li>
  <li>Open the various sites that are to be tested using the adb shell.</li>
  <li>After the benchmarks have completed, open Trepn Profiler again and select “Stop Profiling”. At this point, it will ask you whether you want to save the data collected in the current session. The data can be saved as a .csv and ‘pull’ed to your machine for further analysis.</li>
</ol>

<h4 id="ddms-profiling">DDMS profiling</h4>
<ol>
  <li>Follow the next few steps just to make sure that you are monitoring the correct method using DDMS.
    <ul>
      <li>Start the browser</li>
      <li>Check PID using
        <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>adb shell ps
</code></pre></div>        </div>
      </li>
      <li>Look for the same PID in the DDMS ‘Device’ tab.</li>
      <li>This is the method (Browser) you will be profiling.</li>
    </ul>
  </li>
  <li>Click on “Start method profiling”.</li>
  <li>Run the benchmarks.</li>
  <li>Click on “Stop method profiling”.</li>
  <li>This opens traceview which shows the ‘Exclusive’ and ‘Inclusive’ execution time of each method in the browser.</li>
  <li>This trace file can be saved for later reference.</li>
</ol>

<h4 id="flash-ics-stock-image-provided-by-bsquare-using-windows7">Flash ICS stock image provided by Bsquare using Windows7</h4>
<p>Refer procedure <a href="http://www.spencerpages.com/wiki/index.php?title=Dragonboard_8060_Development#Upgrading_to_the_Bsquare_Ice_Cream_Sandwich_Image_.28Windows_only.29" rel="external nofollow noopener" target="_blank">here</a> with the following changes:</p>

<p>After downloading ADT bundle start SDKManager.exe. It should load android sdk manager and show Install 1 package. Click install.</p>

<p>Usb driver will be installed in adt-bundle-windows-x86-20130219\sdk\extras\google\usb_driver
The folder .android is not in “documents and settings”. It is in C:\Users\.android
adb has moved to platform-tools.</p>

<h4 id="making-android-stock-browser-modifications">Making Android Stock browser modifications</h4>
<p>Once you have the source you may make changes and recompile source, then flash images or alternatively:</p>

<p>Pull stock browser for backup</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb pull /system/app/Browser.apk
</code></pre></div></div>
<p>Remove/Uninstall the stock browser using:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb remount
adb shell <span class="nb">rm</span> /system/app/Browser.apk
</code></pre></div></div>
<p>Do “adb reboot”
Install your browser using:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>APQ8060_ICS/out/target/product/msm8660_surf/system/app
adb push ./Browser.apk /system/app/
</code></pre></div></div>

<p>Profiling sunspider with DDMS/traceview will show major chunk on time being spent in sharedTimerFired which belongs in webkit package. The WebKit Java Bridge is in frameworks/base/core/java/android/webkit/Jwebcorejavabridge and in external/webkit/Source/WebKit/android/jni/JavaBridge.cpp. Changes to the timers are in external/webkit/Source/WebCore/platform/ThreadTimers.cpp.</p>

<p>The libraries, once compiled, will be found in out/target/product/msm8660_surf/system/lib. The perf tool showed major time being used by libv8.so and libwebcore.so. But a “ls -la” in the above directory shows libwebcore.so being updated after making changes to shared timer code. Hence push this file to /system/lib and also push the app Browser.apk</p>

<h4 id="makefile-to-compile-kmod-for-android-ics-source">Makefile to compile KMOD for Android ICS source</h4>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KERNEL_BUILD :<span class="o">=</span> out/target/product/msm8660_surf/obj/KERNEL_OBJ/
KERNEL_CROSS_COMPILE :<span class="o">=</span> prebuilt/darwin-x86/toolchain/arm-eabi-4.4.3/bin/arm-eabi-

obj-m +<span class="o">=</span> 8x60_oc.o

all:
	make <span class="nt">-C</span> <span class="si">$(</span>KERNEL_BUILD<span class="si">)</span> <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span><span class="si">$(</span>KERNEL_CROSS_COMPILE<span class="si">)</span> <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>PWD<span class="si">)</span> modules

clean:
	make <span class="nt">-C</span> <span class="si">$(</span>KERNEL_BUILD<span class="si">)</span> <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>PWD<span class="si">)</span> clean 2&gt; /dev/null
	<span class="nb">rm</span> <span class="nt">-f</span> modules.order <span class="k">*</span>~
</code></pre></div></div>

<h4 id="monitor-kernel-oops">Monitor Kernel oops</h4>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell
<span class="nb">cat</span> /proc/kmsg
</code></pre></div></div>

<h4 id="reboot-in-fastboot-if-mdp-refuses-to-boot-up">Reboot in fastboot if MDP refuses to boot up</h4>

<p>Disconnect all power and keep the 5 key pressed when you connect the power. Do “fastboot devices” to check for the MDP.</p>

<h4 id="permitting-apps-to-use-root">Permitting apps to use root</h4>
<p>Download SuperSU (the broker app which allows user apps to gain root access)</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://download.chainfire.eu/315/SuperSU/UPDATE-SuperSU-v1.25.zip
</code></pre></div></div>
<p>Extract the zip file. Push the Superuser.apk to /system/app</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb push Superuser.apk /system/app
</code></pre></div></div>
<p>Push the su binary to /system/bin</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb push su /system/bin
</code></pre></div></div>
<p>Make the binary owned by root</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell <span class="nb">chown </span>0.0 /system/bin/su
</code></pre></div></div>
<p>Make the binary executable, setuid, and setgid</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell <span class="nb">chmod </span>6755 /system/bin/su
</code></pre></div></div>
<p>Reboot the phone</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb reboot
</code></pre></div></div>
<p>Start SuperSU from the launcher</p>

<p>Launch SetCPU app and grant it su permissions. Then use it to increase CPU frequency or alternatively use:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell
<span class="nb">echo</span> <span class="s2">"performance"</span> <span class="o">&gt;</span> /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
</code></pre></div></div>

<h4 id="mount-ntfs-filesystem-on-ubuntu-with-read-writeexecution-permissions-in-case-you-wish-to-compile-on-external-drive">Mount NTFS filesystem on Ubuntu with read-write/execution permissions (In case you wish to compile on external drive)</h4>

<p>Insert/mount your do “sudo blkid” and note the device file for your disk “/dev/sdc1” (in my case).
unmount the disk</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /media/harddisk
<span class="nb">sudo </span>mount <span class="nt">-t</span> ntfs <span class="nt">-o</span> <span class="nv">fmask</span><span class="o">=</span>0022,dmask<span class="o">=</span>0000,uid<span class="o">=</span>1000,gid<span class="o">=</span>1000 /dev/sdc1 /media/harddisk
</code></pre></div></div>

<h4 id="compiling-ics-from-source">Compiling ICS from source</h4>
<p>Follow all of the steps mentioned <a href="http://source.android.com/source/initializing.html" rel="external nofollow noopener" target="_blank">here</a>. Specifically the ones under Branch 4.0.x and previous since you will be compiling ICS.</p>

<p>Also follow the steps given at <a href="http://www.spencerpages.com/wiki/index.php?title=Dragonboard_8060_Development#Recreating_the_Ice_Cream_Sandwich_Source" rel="external nofollow noopener" target="_blank">Spencerpages</a> (do not use the fixes mentioned for errors in case you are on MAC)</p>

<p>We managed to compile the ICS source on two different platforms, Ubuntu 12.04 LTS (32-bit) and Mac OS X (10.8.3).</p>

<h4 id="compile-android-ics-on-ubuntu-1204-lts-32-bit">Compile Android ICS on Ubuntu 12.04 LTS (32-bit)</h4>

<p>Changes specific to Ubuntu 12.04 LTS (32-bit) are as follows:
After the Step 8 mentioned in “ Recreating the Ice Cream Sandwich” section in spencer pages, you might encounter the following errors:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error occurred during initialization of VM
make: <span class="k">***</span> <span class="o">[</span>out/target/common/obj/JAVA_LIBRARIES/core_intermediates/noproguard.classes-with-local.dex] Error 1
</code></pre></div></div>
<p>OR</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Could not create the Java virtual machine.
ERROR: signapk.jar failed: <span class="k">return </span>code 1
make: <span class="k">***</span> <span class="o">[</span>out/target/product/msm8660_surf/msm8660_surf-ota-eng.falcon.zip] Error 1
</code></pre></div></div>

<p><strong>Fix:</strong></p>

<p>Modify <code class="language-plaintext highlighter-rouge">build/core/definitions.mk</code>. On Line 1528 change Xmx to 1024M</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$(if $(findstring windows,$(HOST_OS)),,-JXms16M -JXmx1024M)
</code></pre></div></div>
<p>In <code class="language-plaintext highlighter-rouge">build/tools/releasetools/common.py</code> change Xmx2048m to Xmx1024m at all occurrences</p>

<h4 id="compile-android-ics-on-mac-os-x-1083">Compile Android ICS on Mac OS X (10.8.3)</h4>

<p>The changes specific to compiling on OS X and those not presented in the two links at the top are mentioned here:</p>

<ol>
  <li>Grab the Mac OS X 10.5 SDK.
Most of the tools that are required will be installed when you grab the latest version of Xcode that is available. Also, do install the “Command Line Tools” from within Xcode.
For the 10.5 SDK, you need to register as an Apple Developer and Download an older version of Xcode that has the 10.5 SDK.
To add the SDK, I re-installed the MacOSX10.5.pkg from the Xcode 3.2.6 download. It is in a hidden folder named “Packages” on the disk image. After mounting the .dmg file, you can open it from the command line with open /Volumes/Xcode\ and\ iOS\ SDK/Packages/. When installing the package, choose change install location and option-click on the drive you want to install to, so that you can specify a folder. The target folder should be /Developer or the base of your Xcode 4 install if you have put it in a non-standard location.</li>
  <li>Get the “real” gcc.
You’ll get a llvm version of gcc with the Xcode Command Line tools install. But that doesn’t seem to like Cross Compilation too much. So, I would suggest get a gcc through macports and make it your default. I used gcc 4.7.</li>
  <li>Errors and their specific fixes:<br>
<strong>Error:</strong>
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>/external/elfutils/config-compat-darwin.h:42: error: static declaration of ‘strnlen’ follows non-static declaration
/usr/include/string.h:143: error: previous declaration of ‘strnlen’ was here
In file included from :0:
</code></pre></div>    </div>
    <p><strong>Fix:</strong>
 In external/elfutils/config-compat-darwin.h, the following built-in gcc preprocessor macro should take care of the strnlen redefinition problem from /usr/include/string.h on OS X &gt;= 10.7.</p>
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> #if __ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__ &lt; 1070
 static inline strneln(…) …
 #endif
</code></pre></div>    </div>
    <p><strong>Error:</strong></p>
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>make: *** [out/host/darwin-x86/obj/EXECUTABLES/qemu-android-x86_intermediates/qemu-android-x86] Error 1
</code></pre></div>    </div>
    <p><strong>Fix:</strong>
Commenting out all lines in external/qemu/Android.mk<br>
<strong>Error:</strong></p>
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>host Executable: sqlite3 (out/host/darwin-x86/obj/EXECUTABLES/sqlite3_intermediates/sqlite3)
Undefined symbols for architecture i386:
“_sqlite3_androidopt_handle_pragma”, referenced from:
_sqlite3Pragma in sqlite3.o
_sqlite3Pragma in sqlite3.o
“_sqlite3_androidopt_open”, referenced from:
_openDatabase in sqlite3.o
_openDatabase in sqlite3.o
ld: symbol(s) not found for architecture i386
collect2: ld returned 1 exit status
make: *** [out/host/darwin-x86/obj/EXECUTABLES/sqlite3_intermediates/sqlite3] Error 1
</code></pre></div>    </div>
    <p><strong>Fix:</strong>
Patch the file android.mk using the patch attached. Android.mk is present in the folder external/sqlite/dist/Android.mk<br>
<strong>Error:</strong></p>
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>Context*, void const*, unsigned long)in libRS.a(rsgApiReplay.o)
ld: symbol(s) not found for architecture i386
collect2: ld returned 1 exit status
make: *** [out/host/darwin-x86/obj/EXECUTABLES/a3dconvert_intermediates/a3dconvert] Error 1
</code></pre></div>    </div>
    <p><strong>Fix:</strong>
Patch the rsAllocation.cpp file using the supplied patch. rsAllocation.cpp is present in the folder
frameworks/base/libs/rs/rsAllocation.cpp<br>
<strong>Error:</strong>
elf.h file not found in two files</p>
    <ol>
      <li>APQ8060_ICS/kernel/scripts/mod/mk_elfconfig.c:4:17: fatal error: elf.h: No such file or directory</li>
      <li>APQ8060_ICS/kernel/scripts/mod/modpost.h:10:17: fatal error: elf.h: No such file or directory</li>
    </ol>

    <p><strong>Fix:</strong>
Follow Elefant – <a href="http://blog.csdn.net/elefant/article/details/7698586" rel="external nofollow noopener" target="_blank">http://blog.csdn.net/elefant/article/details/7698586</a><br>
Manually download elf.h from <a href="http://www.rockbox.org/tracker/9006?getfile=16683" rel="external nofollow noopener" target="_blank">http://www.rockbox.org/tracker/9006?getfile=16683</a><br>
Place it in the directory “kernel/scripts/mod”
Include the correct header file in the two files mk_elfconfig.c and modpost.h.
Do include “elf.h” instead of &lt;elh.h&gt;</p>
  </li>
</ol>

  </article>
  <p class="post-tags">
    <a href="/blog/2013"> <i class="fas fa-calendar fa-sm"></i> 2013 </a>
      ·  
    <a href="/blog/category/embedded-systems">
      <i class="fas fa-tag fa-sm"></i> Embedded Systems</a>
    
  </p>

</div>

    </div>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
